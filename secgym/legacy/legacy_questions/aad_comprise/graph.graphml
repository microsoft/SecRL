<?xml version='1.0' encoding='utf-8'?>
<graphml xmlns="http://graphml.graphdrawing.org/xmlns" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://graphml.graphdrawing.org/xmlns http://graphml.graphdrawing.org/xmlns/1.0/graphml.xsd"><key id="d4" for="node" attr.name="additional_info" attr.type="string"/>
<key id="d3" for="node" attr.name="kql_query" attr.type="string"/>
<key id="d2" for="node" attr.name="table_name" attr.type="string"/>
<key id="d1" for="node" attr.name="description" attr.type="string"/>
<key id="d0" for="node" attr.name="type" attr.type="string"/>
<graph edgedefault="undirected"><node id="1">
  <data key="d0">IoC</data>
  <data key="d1">There is a suspicious email reading event, where the emails are read with Graph API through a previously unknown application registration.</data>
</node>
<node id="2">
  <data key="d0">Investigation</data>
  <data key="d1">Check table `OfficeActivity` with Graph API's id for mail read events.</data>
  <data key="d2">OfficeActivity</data>
  <data key="d3">OfficeActivity | where Operation == 'MailItemsAccessed' and AppId == '00000003-0000-0000-c000-000000000000'</data>
</node>
<node id="3">
  <data key="d0">IoC</data>
  <data key="d1">ClientAppId: bb77fe0b-52af-4f26-9bc7-19aa48854ebf</data>
</node>
<node id="4">
  <data key="d0">IoC</data>
  <data key="d1">MailboxOwnerUPN: mmelendez@DefenderATEVET17.onmicrosoft.com</data>
  <data key="d4">The user's mailbox who was accessed.</data>
</node>
<node id="5">
  <data key="d0">Investigation</data>
  <data key="d1">Check table `SecurityExposureManagement` to find more information about the client app with that ID.</data>
  <data key="d2">SecurityExposureManagement</data>
</node>
<node id="6">
  <data key="d0">IoC</data>
  <data key="d1">ObjectId: 47dee0a2-d662-4664-acfa-a28bb62bdbc0</data>
</node>
<node id="7">
  <data key="d0">Investigation</data>
  <data key="d1">Check `AADServicePrincipalSignInLogs` to identify the last time this client app with `ClientAppId` was authenticated.</data>
  <data key="d2">AADServicePrincipalSignInLogs</data>
  <data key="d3">AADServicePrincipalSignInLogs | where AppId == 'bb77fe0b-52af-4f26-9bc7-19aa48854ebf'</data>
</node>
<node id="8">
  <data key="d0">IoC</data>
  <data key="d1">IPAddress: 72.43.121.34</data>
  <data key="d4">The IP address where the service principal authenticated from.</data>
</node>
<node id="9">
  <data key="d0">Investigation</data>
  <data key="d1">Check `SigninLogs` for other authentication events from the same IP address.</data>
  <data key="d2">SigninLogs</data>
  <data key="d3">SigninLogs | where IPAddress == '72.43.121.34' | project TimeGenerated, IPAddress, UserPrincipalName, ResultType, ResultDescription, AuthenticationRequirement, ConditionalAccessStatus, ResourceDisplayName, AppDisplayName, ResourceIdentity, ClientAppUsed, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskEventTypes</data>
</node>
<node id="10">
  <data key="d0">IoC</data>
  <data key="d1">Multiple users are authenticating from the same IP address but failed. There is one account that successfully authenticated: mvelazco@defenderatevet17.onmicrosoft.com.</data>
</node>
<node id="11">
  <data key="d0">Investigation</data>
  <data key="d1">Check `AuditLogs` for the latest actions that have occurred to this application registration: modifications, updates, etc.</data>
  <data key="d2">AuditLogs</data>
  <data key="d3">AuditLogs | mv-expand TargetResource = TargetResources | extend TargetResourceJson = parse_json(TargetResource) | where TargetResourceJson.id == '47dee0a2-d662-4664-acfa-a28bb62bdbc0'</data>
</node>
<node id="12">
  <data key="d0">IoC</data>
  <data key="d1">We learn that certain changes were made against the application. Specifically, new credentials were added to the application registration right before it authenticated.</data>
</node>
<node id="13">
  <data key="d0">Investigation</data>
  <data key="d1">Check other activities with the same IP address, such as Microsoft Graph API requests.</data>
  <data key="d2">MicrosoftGraphActivityLogs</data>
  <data key="d3">MicrosoftGraphActivityLogs | where RequestUri endswith '/users' or RequestUri endswith '/applications' | where IPAddress == '72.43.121.34'</data>
</node>
<node id="14">
  <data key="d0">IoC</data>
  <data key="d1">The same IP address is making requests to the Microsoft Graph API for both users and applications.</data>
</node>
<edge source="1" target="2"/>
<edge source="2" target="3"/>
<edge source="2" target="4"/>
<edge source="3" target="5"/>
<edge source="3" target="7"/>
<edge source="5" target="6"/>
<edge source="6" target="11"/>
<edge source="7" target="8"/>
<edge source="8" target="9"/>
<edge source="8" target="13"/>
<edge source="9" target="10"/>
<edge source="11" target="12"/>
<edge source="13" target="14"/>
</graph></graphml>